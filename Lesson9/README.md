# Домашнее задание "Пишем скрипт"

## Описание/Пошаговая инструкция выполнения домашнего задания:

Написать скрипт для CRON, который раз в час будет формировать письмо и отправлять на заданную почту.
Необходимая информация в письме:

* Список IP адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта;
* Список запрашиваемых URL (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта;
* Ошибки веб-сервера/приложения c момента последнего запуска;
* Список всех кодов HTTP ответа с указанием их кол-ва с момента последнего запуска скрипта.
* Скрипт должен предотвращать одновременный запуск нескольких копий, до его завершения.

## Запуск

```
vagrant up
```

#### Файлы

1. ./scripts/init.sh - подготовка окружения, установка в cron запуска скрипта worker.sh на запус по расписанию;
2. ./scripts/worker.sh - обработчик лога, само домашнее задание;
3. /home/vagrant/logs/access.log - скачиваемый apache log для разбора. 
Источник: http://www.almhuette-raith.at/apache-log/access.log 
Найден через поисковик google запросом: "inurl:apache-log/access.log"
4. /home/vagrant/logs/result.txt - результат анализа;
5. /var/run/worker/lock.pid - файл предоствращающий повторный запуск скрипта;
6. /home/vagrant/logs/last_start_date.save - файл содержащий дату и время последнего запуска.
 
#### Проверка работоспособности

Зайти на guest.
```
vagrant ssh
```
Проверить наличие файла /vagrant/logs/result.txt и результаты обработки.

Или непосредственно запустить скрипт:
```
/vagrant/scripts/worker.sh -n 3 -e vlyulin@gmail.com
```

## Комментарии 

1. Даты сообщений лога и "момент последнего запуска скрипта" сравниваются как числа. Для этого они преобразуются в секунды с 1970-01-01 00:00:00 UTC.

2. Разбор сообщений в лог файле для определения записей попадающих в нужный временной диапазон выполняется один раз. Далее определение статистики выполняется только с соответствующим фрагментом файла.

3. Сканирование лог файла выполняется с конца, что делает разбор более оптимальным и меньшим по времени.

## Результат обработки

```
08/Feb/2023:22:05:05
Обработка с 04/Feb/2023:00:00:00 по 08/Feb/2023:22:05:05


Список IP адресов с наибольшим кол-вом запросов c момента последнего запуска скрипта:
     76 89.144.208.32
     34 185.44.77.153
     22 138.201.30.176


Список URL адресов с наибольшим кол-вом запросов c момента последнего запуска скрипта:
     68 http://www.almhuette-raith.at/
     41 http://www.almhuette-raith.at/index.php?option=com_phocagallery&view=category&id=1&Itemid=53
     23 http://www.website-datenbank.de/


Ошибки веб-сервера/приложения:
132.154.58.174 - - [04/Feb/2023:00:24:17 +0100] "GET /favicon.ico HTTP/1.1" 404 217 "http://www.almhuette-raith.at/apache-log/access.log" "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/109.0" "-"
62.138.2.160 - - [04/Feb/2023:00:55:02 +0100] "GET /sitemap.xml HTTP/1.1" 404 217 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:103.0) Gecko/20100101 Firefox/103.0" "-"
191.101.31.254 - - [04/Feb/2023:02:42:05 +0100] "GET /index.php?option=com_easyblog&view=dashboard&layout=write HTTP/1.1" 404 1397 "http://www.almhuette-raith.at" "Mozilla/5.0 (Macintosh; Intel Mac OS X 12_5) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Safari/605.1.15" "-"


Список всех кодов HTTP ответа с указанием их кол-ва с момента последнего запуска скрипта:
    213 200
     49 404
```

